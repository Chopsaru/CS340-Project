{% extends "menu.html" %}
{% block content %}

<div class="orders">
    <h1>Order Management</h1>
</div>
<form id="orderForm" action="/Orders" method="POST">
    <div class="form-row">
        <div class="col">
            <label for="custSelect">Customer</label>
            <select class="form-control" name="cust_id" id="custSelect" required>
                {% for c in custDD %}
                <option value="{{c.0}}">{{c.1}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <label for="empSelect">Employee</label>
            <select class="form-control" name="emp_id" id="empSelect" required>
                {% for e in empDD %}
                <option value="{{e.0}}">{{e.1}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <label for="dateInput">Date</label>
            <input type="date" class="form-control" name="date" id="dateInput" value="2020-02-10" required>
        </div>
    </div>
    <div class="form-row">
        <div class="col">
            <label for="creditCardNum">Credit card number</label>
            <input type="number" class="form-control" name="credit_card_num" id="creditCardNum" value="1111222233334444" maxlength="16" minlength="16" required>
        </div>
        <div class="col">
            <label for="expDateInput">Expiration date</label>
            <input type="date" class="form-control" name="exp_date" id="expDateInput" value="2023-03-01" required>
        </div>
        <div class="col">
            <label for="creditCardCode">Credit card code</label>
            <input type="number" class="form-control" name="credit_card_code" id="creditCardCode" value="123" maxlength="4" minlength="3" required>
        </div>
    </div>
    <div class="form-row">
        <div class="input-group">
            <div class="col-md-10">
                <label for="itemSelect">Items</label>
                <select class="form-control" name="item_id" id="itemSelect" required>
                    <option selected disabled hidden>Select item</option>
                    {% for i in itemDD %}
                    <option value="{{i.0}}">{{i.1}}, {{i.2}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="quantityInput">Quantity</label>
                <input type="number" class="form-control" name="quantity" id="quantityInput" required>
            </div>
        </div>
    </div>
</form>
<button class="btn btn-secondary mb-3" id="addItemBtn" type="submit" form="orderForm">Add item to order</button>
<br>
<button class="btn btn-success mb-3" type="submit" form="orderForm">Submit order</button>

<table id="ordersTable" class="table table-bordered table-sm">
    <thead>
        <tr>
            <th></th>
            <th class="th-sm" scope="col">Order id</th>
            <th class="th-sm" scope="col">Customer</th>
            <th class="th-sm" scope="col">Employee</th>
            <th class="th-sm" scope="col">Date</th>
            <th class="th-sm" scope="col">Total</th>
            <th class="th-sm" scope="col">Credit card number</th>
            <th class="th-sm" scope="col">Expiration date</th>
            <th class="th-sm" scope="col">Credit card code</th>
            <th scope="col"></th>
            <th scope="col"></th>
        </tr>
    </thead>
    <tbody>
        {% for r in rows %}
        <tr data-child-value="{{r.0}}, {{itemRow}}">
            <td class="details-control"></td>
            <td>{{r.0}}</td>
            <td>{{r[1]}}</td>
            <td>{{r[2]}}</td>
            <td>{{r[3]}}</td>
            <td>{{r[4]}}</td>
            <td>{{r[5]}}</td>
            <td>{{r[6]}}</td>
            <td>{{r[7]}}</td>
            <td class="rowBtn"><button class="btn btn-primary" type="submit" onclick="window.location='/Orders/edit/{{r.0}}'">Edit</button></td>
            <td><button class="rowBtn, btn btn-danger" type="submit" onclick="window.location='/deleteOrder/{{r.0}}'">Delete</button></td>
        </tr>
        <!--
     <tr>
         <td></td>
         <td colspan="4">
             <div id="items_{{r.0}}" style="display: none;">
                 {% for items in itemRow %}
                 {% if r.0 == items.0 %}
                 <br>{{items[2]}}x,&nbsp
                 {{items[1]}},&nbsp
                 {{items[3]}}
                 {% endif %}
                 {% endfor %}
             </div>
         </td>
     </tr>
        -->
        {% endfor %}

    </tbody>

</table>

<script>
        /* Formatting function for row details - modify as you need */
    function format (id, items) {
        // `d` is the original data object for the row
        console.log(id)
        console.log(items)
        var itemTable;
        for (i = 0; i < items.length; i++) {
            if (id == items[0]) {
                itemTable = '<tr>' +
                    '<td>' + items[2] + '</td>' +
                    '<td>' + items[1] + '</td>' +
                    '<td>' + items[3] + '</td>' +
                    '</tr>';
                }
        }
        return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
            '<tr>'+
                '<td>Quantity:</td>' +
                '<td>Name: </td>' +
                '<td>Price:</td>'+
            '</tr>'+
            itemTable +
            '<tr>'+
            '</tr>'+
        '</table>';
    }

    $(document).ready(function() {
        var table = $('#ordersTable').DataTable( {
        } );

        // Add event listener for opening and closing details
        $('#ordersTable tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row( tr );

            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                row.child( format(row.data()) ).show();
                tr.addClass('shown');
            }
        } );
    } );
</script>


<script>
    var count = 1;
    $("#addItemBtn").click(function (event) {
        event.preventDefault();

        $("#orderForm").append(addNewRow(count));
        count++;
    });

    function addNewRow(count) {
        var newrow =
            '<div class="form-row">' +
                '<div class="input-group">' +
                    '<div class="col-md-10">' +
                        '<select class="form-control" name="item_id_' + count + '" id="itemSelect" required>' +
                            '<option selected disabled hidden>Select item</option>' +
                            '{% for i in itemDD %}' +
                            '<option value="{{i.0}}">{{i.1}}, {{i.2}}</option>' +
                            '{% endfor %}' +
                        '</select>' +
                    '</div>' +
                    '<div class="col-md-2">' +
                        '<input type="number" class="form-control" name="quantity_' + count + '" id="quantityInput">' +
                    '</div>' +
                '</div>' +
            '</div>';
        return newrow;
    }
</script>


{% endblock %}